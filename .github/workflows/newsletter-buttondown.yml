name: CT/MRI×AI Weekly (Buttondown)

on:
  schedule:
    # GitHub Actions の cron は UTC。JST(月曜12:00) = UTC(月曜03:00)
    - cron: "0 3 * * 1"
  workflow_dispatch:

permissions:
  contents: write
  issues: write

concurrency:
  group: newsletter-buttondown
  cancel-in-progress: false

jobs:
  run-newsletter:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v3
      - name: Install dependencies
        run: uv sync --locked
      - name: Run tests
        run: uv run pytest
      - name: Execute pipeline
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PUBMED_API_KEY: ${{ secrets.PUBMED_API_KEY }}
          BUTTONDOWN_API_KEY: ${{ secrets.BUTTONDOWN_API_KEY }}
          # 本番配信: GitHub Actions からの送信を明示的に許可する
          BUTTONDOWN_ALLOW_ACTIONS_SEND: "true"
          # Buttondown 側へ「送信直前」のステータスで投げる（ドラフトではなく配信）
          BUTTONDOWN_STATUS: about_to_send
          NEWSLETTER_TEMPLATE_PATH: configs/base/newsletter_template.yaml
          PYTHONPATH: ${{ github.workspace }}:${{ github.workspace }}/src
        run: uv run python scripts/run_pipeline.py
      - name: Commit newsletter archive
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "github-actions"
          git add issues || true
          if git diff --cached --quiet; then
            echo "No changes"
            exit 0
          fi
          git commit -m "[Automated] Update CT/MRI×AI Weekly archive"
          git push

      - name: Notify failure (create GitHub Issue)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const dateStr = new Date().toISOString().slice(0, 10);
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const title = `[Auto] CT/MRI×AI Weekly failed (${dateStr})`;
            const body = [
              `ニュースレター自動配信の workflow が失敗しました。`,
              ``,
              `- Workflow: ${context.workflow}`,
              `- Run: ${runUrl}`,
              `- Commit: ${context.sha}`,
              ``,
              `まずは Run のログを確認してください。`,
            ].join("\n");
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
            });
